<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<title>SQL Reports | Koha GiftED | Eric Phetteplace</title>

		<link rel="stylesheet" href="dist/reset.css">
		<link rel="stylesheet" href="dist/reveal.css">
		<link rel="stylesheet" href="dist/theme/night.css">

		<!-- Theme used for syntax highlighted code -->
		<link rel="stylesheet" href="plugin/highlight/monokai.css">

<style>
/* custom styles */
.reveal .slides p {
	text-align: left;
}
.reveal .slides h2 code,
.reveal .slides p code {
	color: tomato;
}
.column {
    display: flex;
    flex-direction: row;
}
.column .row {
    flex: 50%;
    padding: 10px;
}
.reveal .slides .text-center {
	text-align: center;
}
</style>
	</head>
	<body>
		<div class="reveal">
			<div class="slides">
				<section style="font-size: 80%;">
					<h1>Koha SQL Reports</h1>
					<h2>GiftED Community Session</h2>
					<h3><small>Eric Phetteplace <a href="mailto:ephetteplace@cca.edu">ephetteplace@cca.edu</a>, Systems Librarian, California College of the Arts</small></h3>
					<p class="text-center"><small>These slides are available at&nbsp;<a href="https://phette23.github.io/koha-gifted-sql/">phette23.github.io/koha-gifted-sql/</a></small></p>
				</section>

				<!-- topics:
					x schema, search engine
					x neverending query
					x deleted* tables
					statistics versus issues table
					x public JSON links
					x reports keep getting better! batch processing, autocomplete
					x get help from #reports channel in bywater slack
				 -->

				<section>
					<h2>Session Specifics</h2>
					<p>General tips and tricks specific to <em>Koha</em> SQL reports and not SQL queries in general.</p>
					<p>There will definitely be some SQL on slides but hopefully nothing too arcane.</p>
					<p>I'm no SQL expert! Please chime in with your own ideas in chat.</p>
				</section>

				<section>
					<h2>What's in a table?</h2>

					<ul>
						<li><a href="https://wiki.koha-community.org/wiki/SQL_Reports_Library">Reports Library</a></li>
						<li>Schema <a href="https://schema.koha-community.org/">schema.koha-community.org/</a></li>
						<li>"Search engine" links to any given table</li>
					</ul>

					<aside class="notes">
						Let's start with how to find the data you're looking for in Koha's many database tables. The most obvious places to look at the ones shown right in the reports
					</aside>
				</section>

				<section>
					<h2>Experimental Queries</h2>
					<p>Peek at what's in a particular table:</p>
					<pre><code>SELECT * FROM deletedbiblio</code></pre>
					<p>Enumerate the values in a field:</p>
					<pre class="fragment"><code>SELECT DISTINCT itype FROM items ORDER BY itype</code></pre>
				</section>

				<section>
					<h2><code>deleted*</code> tables</h2>
					<p>Deleted biblios (and their metadata), items, and borrowers (patrons) are not removed from the database permanently but transferred to a new table with a "deleted" prefix.</p>
					<p>Similarly, past issues (checkouts) and holds (reserves) are moved to tables prefixed with "old".</p>
					<p>Many reports, to be entirely accurate, must factor in these "deleted" or "old" tables.</p>
				</section>

				<section>
					<h2>Use a <code>UNION</code> in a subquery</h2>
					<p><em>All</em> biblios:</p>
<pre><code>SELECT * FROM (
	SELECT * FROM biblio
	UNION
	SELECT * FROM deletedbiblio) b
ORDER BY b.biblionumber</code></pre>
				</section>

				<section>
					<h2>Annotate combined tables</h2>
					<p>Combined items table has a "status" column.</p>
<pre><code>SELECT i.status, i.itemnumber, i.itype FROM
	(SELECT "live" as status, i.* FROM items i
	UNION
	SELECT "deleted" as status, di.* FROM deleteditems di) i</code></pre>
<table>
	<tr>
		<th>status</th>
		<th>itemnumber</th>
		<th>itype</th>
	</tr>
	<tr>
		<td>live</td>
		<td>1</td>
		<td>BOOK</td>
	</tr>
	<tr>
		<td>deleted</td>
		<td>2</td>
		<td>BOOK</td>
	</tr>
</table>
				</section>

				<section>
					<h2>Example: Collection Size on a Given Date</h2>
					<!-- TODO -->
				</section>

				<section>
					<h2><code>statistics</code> versus <code>issues</code> table</h2>
					<p>Rather than combine <code>issues</code> & <code>oldissues</code> for circulation figures, use <code>statistics</code>.</p>
					<p>The <code>issues</code> tables have no item information & <code>JOIN</code>ing them to the <code>items</code> tables does not account for changes in item type or location since the checkout occurred.</p>

					<aside class="notes">
						I think intuitively when one goes to build a circulation report, we turn to the "issues" tables that hold old and current checkouts. But the issues don't record any item information, so to look at properties like item type, location, branch, etc. we have to join to the items table. But the items table is for <em>current</em>, not historical, information.
						Consider this example: a faculty member puts an item on reserve which we implement by changing the item type to "2DAYRESERVE" and that changes the circulation rules for the item. Several students check out the item. After the term ends, the title is returned to the main shelves and it's item type reset to "BOOK". A report which uses the "issues" table would show this as a "BOOK" checkout, not a "2DAYRESERVE" checkout.
						That's where the "statistics" table comes in. It records the item type, shelving location, branch, collection code, and patron category <em>at the time of the checkout</em>.
					</aside>
				</section>

				<section>
					<h2>Checkouts by Branch</h2>
					<p>SQL by Nicole C. Engard, ByWater Solutions</p>
<pre><code>SELECT branch,
MONTH(datetime) AS month,
YEAR(datetime) AS year,
COUNT(datetime) AS checkouts
FROM statistics
WHERE type LIKE 'issue'
GROUP BY branch, year, month
ORDER BY year ASC, month ASC, branch ASC</code></pre>

<aside class="notes">Here's an example circulation report using the statistics table which was written by Nicole C. Engard. It shows checkouts per month per branch. We closed one of our branches, but this report still shows that branches historical checkouts, because it uses the statistics table.</aside>
				</section>

				<section>
					<h2>Show Authorized Values</h2>
					<p>Fields that use an authorized value as a controlled vocabularly store the AV <em>code</em> and not it's human readable label, but we can connect to the AV table to fix that</p>
					<p>For example, the "itype" field in the "items" table:</p>
				</section>

				<section>
					<h2>Public JSON Data</h2>
					<p>You can make a report's data easily accessible to external programs by setting it to "Public" and copying its JSON URL. The URLs look like:</p>
					<p>https://koha.library.org/cgi-bin/koha/svc/report?id=42</p>
					<p><strong>Note: public means public!</strong> Don't use this with confidential information.</p>
				</section>

				<section>
					<h2>Example: add MARC Field to OPAC</h2>
					<!-- TODO check that this all works and use a different field -->
					<p>Report with runtime parameter:</p>
<pre><code><script type="text/template">SELECT ExtractValue(marcxml, '//datafield[@tag="245"]/subfield[@code="a"]') as title
FROM bibliometadata bm
WHERE bm.biblionumber = <<biblionumber>>
</script></code></pre>
					<p>OPACUserJS:</p>
<pre><code>const id = new URLSearchParams(location.search).get("biblionumber")
$.get(`https://koha.library.org/cgi-bin/koha/svc/report?id=42&sql_params=${id}`, (data) => {
	$("#title").text(data[0][0])
})</code></pre>
				</section>

				<section>
					<h2>Reports Keep Getting Better!</h2>
					<!-- TODO what else is new? -->
					<p>ID columns (biblionumber, borrowernumber) connect to bulk operations</p>
					<p>Autocompletion</p>
					<p>"Update and run" button</p>
				</section>

				<section>
					<h2><code>#reports</code> channel in BWS-Partners Slack</h2>
					<p>For instance, Koha reports won't allow the words <code>UPDATE</code>, <code>DELETE</code>, <code>DROP</code>, <code>INSERT</code>, <code>SHOW</code>, or <code>CREATE</code> <em>anywhere</em>, even in comments or strings. But folks had handy suggestions like:</p>
<pre><code>SELECT * FROM biblio
WHERE title LIKE CONCAT('%Rocky Horror Picture Sh','ow%')</code></pre>
				</section>

				<section>
					<h2>Questions?</h2>

					<p>Thanks for coming! These slides are available at <a href="https://phette23.github.io/koha-gifted-sql/">phette23.github.io/koha-gifted-sql/</a>.</p>
					<div class="column">
						<div class="row">
							<p>Eric Phetteplace</p>
							<p>Systems Librarian</p>
							<p>California College of the Arts</p>
							<p><a href="https://libraries.cca.edu">libraries.cca.edu</a></p>
						</div>
						<div class="row">
							<p><a href="https://digipres.club/@phette23">@phette23@digipres.club</a></p>
							<p><a href="https://phette.net">phette.net</a></p>
							<p><a href="https://github.com/phette23">@phette23 on GitHub</a></p>
						</div>
					</div>
				</section>

				</section>
			</div>
		</div>

		<script src="dist/reveal.js"></script>
		<script src="plugin/notes/notes.js"></script>
		<script src="plugin/markdown/markdown.js"></script>
		<script src="plugin/highlight/highlight.js"></script>
		<script>
			// More info about initialization & config:
			// - https://revealjs.com/initialization/
			// - https://revealjs.com/config/
			Reveal.initialize({
				hash: true,

				// Learn about plugins: https://revealjs.com/plugins/
				plugins: [ RevealMarkdown, RevealHighlight, RevealNotes ]
			});
		</script>
	</body>
</html>
